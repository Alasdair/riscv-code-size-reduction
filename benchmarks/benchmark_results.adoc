## Zce Code saving estimation criteria 
// :Version 0.1
// :doctype: book
// :encoding: utf-8
// :lang: en
// :toc: left
// :toclevels: 4
// :numbered:
// :xrefstyle: short
// :le: &#8804;
// :rarr: &#8658;


# Benchmarking Baground: 
This document present benchmarking results for Zce extension, baseline files were compiled using gcc10.2.0-r4 with -Os. All results are generated from static analysis, and
file sizes are calculated based on parsed instruction sizes of the ELF files, and the optimized sizes are calculated based on parsed instruction with relevant Zce instructions. 


# Zcec Subset: 

## C.TBLJAL
.. Find all (JAL, JALR, J and JR) instructions to be considered for replacement.
.. Remove entries that we won't gain any code saving from substituting, When number of identical (JAL or J) <  3.
.. Change the weight of JALR and JR entries to 3*Count (This would give them priority in selection, since their replacement results in more code saving).
.. Get the top 512 entries.
.. Replace the entries in instruction record with the TBLJAL entries, and calculate the gains and compensate for the table size.

.TBLJAL 512 
[options="header", format="csv"]
|=======================
File , Size,Optimized Size, Table Length, Saving
huawei_iot_application.elf,344742.0,314432.0,512,8.792082194800754%
huawei_iot_protocol.elf,963736.0,895832.0,512,7.0459129886192855%
zephyr_peripheral.elf,76246.0,71232.0,221,6.576082679747131%
zephyr_central.elf,43434.0,40900.0,133,5.834139153658424%
embench_picojpeg.elf,8474.0,8312.0,9,1.9117299976398439%
embench_wikisort.elf,4434.0,4416.0,4,0.4059539918809252%
embench_qrduino.elf,6218.0,6212.0,2,0.09649404953361307%
embench_nettle-sha256.elf,5622.0,5618.0,1,0.07114905727498844%
embench_ud.elf,686.0,686.0,0,0.0%
embench_st.elf,618.0,618.0,0,0.0%
embench_statemate.elf,4116.0,4116.0,0,0.0%
embench_slre.elf,2582.0,2582.0,0,0.0%
embench_sglib-combined.elf,2472.0,2472.0,0,0.0%
embench_nsichneu.elf,15014.0,15014.0,0,0.0%
embench_nettle-aes.elf,2810.0,2810.0,0,0.0%
embench_nbody.elf,564.0,564.0,0,0.0%
embench_minver.elf,942.0,942.0,0,0.0%
embench_matmult-int.elf,446.0,446.0,0,0.0%
embench_huffbench.elf,1674.0,1674.0,0,0.0%
embench_edn.elf,1500.0,1500.0,0,0.0%
embench_cubic.elf,2264.0,2264.0,0,0.0%
embench_crc32.elf,228.0,228.0,0,0.0%
embench_aha-mont64.elf,1080.0,1080.0,0,0.0%
|=======================

## C.MVA01S07, C.MVA23S07 and C.MVP
.. Find all moves consecutive moves
.. Filter moves that fit the criteria for each of the proposed encoding
.. Overwrite each multiple move that fit the replacement criteria  with the new moves instruction

.MVAxxSyy
[options="header,footer"]
|=======================
|File Name|File Size|MVA01S07|MVA23S07|MVA01S03|MVA23S03
|huawei_iot_protocol.elf|978958|0.22%|0.07%|0.13%|0.04%
|huawei_iot_application.elf|344988|0.31%|0.09%|0.20%|0.06%
|opus_demo_float.elf|215548|0.37%|0.12%|0.24%|0.05%
|testfloat.elf|214658|0.30%|0.09%|0.14%|0.04%
|opus_demo_fixed.elf|202084|0.25%|0.03%|0.17%|0.01%
|fpmark-inner-product-mid-10k.elf|124838|0.71%|0.14%|0.47%|0.07%
|fpmark-radix2-sml-2k.elf|118434|0.68%|0.16%|0.46%|0.07%
|fpmark-xp1px-sml-c100n20.elf|114926|0.69%|0.17%|0.47%|0.07%
|fpmark-atan-1M.elf|113424|0.64%|0.13%|0.45%|0.06%
|zephry_peripheral.elf|76360|0.45%|0.01%|0.34%|0.01%
|coremark.elf|54700|0.50%|0.04%|0.41%|0.03%
|zephry_central.elf|43366|0.53%|0.01%|0.42%|0.01%
|embench_nsichneu.elf|15046|0.00%|0.00%|0.00%|0.00%
|embench_picojpeg.elf|8116|0.05%|0.00%|0.05%|0.00%
|embench_qrduino.elf|6100|0.36%|0.00%|0.30%|0.00%
|embench_nettle-sha256.elf|5558|0.11%|0.00%|0.07%|0.00%
|embench_wikisort.elf|4140|0.24%|0.14%|0.19%|0.05%
|embench_statemate.elf|3926|0.00%|0.00%|0.00%|0.00%
|embench_nettle-aes.elf|2774|0.07%|0.00%|0.07%|0.00%
|embench_slre.elf|2550|0.00%|0.24%|0.00%|0.16%
|embench_sglib-combined.elf|2354|0.17%|0.00%|0.08%|0.00%
|embench_cubic.elf|2270|0.35%|0.00%|0.35%|0.00%
|embench_huffbench.elf|1658|0.24%|0.12%|0.00%|0.00%
|embench_edn.elf|1344|0.00%|0.00%|0.00%|0.00%
|embench_aha-mont64.elf|1062|0.56%|0.38%|0.00%|0.38%
|embench_minver.elf|918|0.00%|0.00%|0.00%|0.00%
|embench_ud.elf|692|0.00%|0.00%|0.00%|0.00%
|embench_st.elf|630|0.00%|0.00%|0.00%|0.00%
|embench_nbody.elf|566|0.00%|0.00%|0.00%|0.00%
|embench_matmult-int.elf|420|0.00%|0.00%|0.00%|0.00%
|embench_crc32.elf|234|0.00%|0.00%|0.00%|0.00%
|=======================

## C.SBSP and  C.LBUSP
.. Find all SB / LBU instructions
.. Replace all the ones that match the following criteria with the proposed compressed instruction
... Stack relative
... Reg name > 7 and Reg name < 16
... Immediate <= 2^5

## C.SHSP and C.LHUSP
.. Find all SH/ LHU instructions
.. Replace all the ones that match the following criteria with the proposed compressed instruction
... Stack relative
... Reg name > 7 and Reg name < 16
... Immediate <= 2^6 and Immediate%2 == 0

.SP Relative Store and Load
[options="header,footer"]
|=======================
|File name|C.LBU|C.LHU|C.SB|C.SH
|coremark.elf|0.00%|0.09%|0.00%|0.06%
|embench_aha-mont64.elf|0.00%|0.00%|0.00%|0.00%
|embench_crc32.elf|0.00%|0.00%|0.00%|0.00%
|embench_cubic.elf|0.00%|0.00%|0.00%|0.00%
|embench_edn.elf|0.00%|0.00%|0.00%|0.00%
|embench_huffbench.elf|0.00%|0.00%|0.00%|0.00%
|embench_matmult-int.elf|0.00%|0.00%|0.00%|0.00%
|embench_minver.elf|0.00%|0.00%|0.00%|0.00%
|embench_nbody.elf|0.00%|0.00%|0.00%|0.00%
|embench_nettle-aes.elf|0.00%|0.00%|0.00%|0.00%
|embench_nettle-sha256.elf|0.00%|0.00%|0.00%|0.00%
|embench_nsichneu.elf|0.00%|0.00%|0.00%|0.00%
|embench_picojpeg.elf|0.00%|0.00%|0.00%|0.00%
|embench_qrduino.elf|0.00%|0.00%|0.00%|0.00%
|embench_sglib-combined.elf|0.00%|0.00%|0.00%|0.00%
|embench_slre.elf|0.00%|0.00%|0.00%|0.00%
|embench_st.elf|0.00%|0.00%|0.00%|0.00%
|embench_statemate.elf|0.00%|0.00%|0.05%|0.00%
|embench_ud.elf|0.00%|0.00%|0.00%|0.00%
|embench_wikisort.elf|0.00%|0.00%|0.00%|0.00%
|fpmark-atan-1M.elf|0.00%|0.05%|0.01%|0.04%
|fpmark-inner-product-mid-10k.elf|0.00%|0.04%|0.00%|0.03%
|fpmark-radix2-sml-2k.elf|0.00%|0.04%|0.01%|0.04%
|fpmark-xp1px-sml-c100n20.elf|0.00%|0.04%|0.00%|0.03%
|huawei_iot_application.elf|0.13%|0.11%|0.20%|0.19%
|huawei_iot_protocol.elf|0.14%|0.09%|0.21%|0.17%
|opus_demo_fixed.elf|0.00%|0.03%|0.00%|0.01%
|opus_demo_float.elf|0.00%|0.02%|0.00%|0.01%
|testfloat.elf|0.06%|0.08%|0.30%|0.01%
|zephry_central.elf|0.07%|0.04%|0.20%|0.19%
|zephry_peripheral.elf|0.06%|0.02%|0.14%|0.14%
|=======================


## C.SEXT.B C.SEXT.H 
.. Find all srai instructions dependent on slli
.. Replace the ones that match the replacement cratiera

## C.ZEXT.B C.ZEXT.H C
.. Find all stli instructions dependent on slli
.. Replace the ones that match the replacement cratiera

## C.LSBNOT 
.. Find all XORI instructions and replace all  the ones that has immediate = 1 with C.LSBNOT  and change WoE to 16

.C.LSBNOT
[options="header,footer"]
|=======================
|File name|File Size|Savings
|huawei_iot_protocol.elf|1228248|0.02%
|huawei_iot_application.elf|388912|0.01%
|opus_demo_float.elf|215798|0.03%
|testfloat.elf|214908|0.03%
|opus_demo_fixed.elf|202334|0.03%
|fpmark-inner-product-mid-10k.elf|125088|0.00%
|fpmark-radix2-sml-2k.elf|118684|0.01%
|fpmark-xp1px-sml-c100n20.elf|115176|0.01%
|fpmark-atan-1M.elf|113674|0.01%
|zephry_peripheral.elf|76982|0.01%
|coremark.elf|54950|0.00%
|zephry_central.elf|43988|0.00%
|embench_nsichneu.elf|15046|0.00%
|embench_picojpeg.elf|8116|0.00%
|embench_qrduino.elf|6100|0.10%
|embench_nettle-sha256.elf|5558|0.00%
|embench_wikisort.elf|4140|0.00%
|embench_statemate.elf|3926|0.00%
|embench_nettle-aes.elf|2774|0.00%
|embench_slre.elf|2550|0.08%
|embench_sglib-combined.elf|2354|0.08%
|embench_cubic.elf|2270|0.00%
|embench_huffbench.elf|1658|0.00%
|embench_edn.elf|1344|0.00%
|embench_aha-mont64.elf|1062|0.19%
|embench_minver.elf|918|0.00%
|embench_ud.elf|692|0.00%
|embench_st.elf|630|0.00%
|embench_nbody.elf|566|0.00%
|embench_matmult-int.elf|420|0.00%
|embench_crc32.elf|234|0.00%
|=======================

## C.MUL
.. Find all multiplication instructions
.. Replace all the ones that match the following criteria with the C.MUL and overwrite WoE to 16 
...  Dst and Src (Reg name > 7 and Reg name < 16)

.C.MUL
[options="header,footer"]
|=======================
|File name|File Size|Savings
|huawei_iot_protocol.elf|1228248|0.29%
|huawei_iot_application.elf|388912|0.16%
|opus_demo_float.elf|215798|0.52%
|testfloat.elf|214908|0.04%
|opus_demo_fixed.elf|202334|0.85%
|fpmark-inner-product-mid-10k.elf|125088|0.06%
|fpmark-radix2-sml-2k.elf|118684|0.06%
|fpmark-xp1px-sml-c100n20.elf|115176|0.06%
|fpmark-atan-1M.elf|113674|0.06%
|zephry_peripheral.elf|76982|0.09%
|coremark.elf|54950|0.12%
|zephry_central.elf|43988|0.12%
|embench_nsichneu.elf|15046|0.00%
|embench_picojpeg.elf|8116|0.42%
|embench_qrduino.elf|6100|0.82%
|embench_nettle-sha256.elf|5558|0.04%
|embench_wikisort.elf|4140|0.05%
|embench_statemate.elf|3926|0.00%
|embench_nettle-aes.elf|2774|0.00%
|embench_slre.elf|2550|0.00%
|embench_sglib-combined.elf|2354|0.00%
|embench_cubic.elf|2270|0.00%
|embench_huffbench.elf|1658|0.00%
|embench_edn.elf|1344|1.34%
|embench_aha-mont64.elf|1062|0.00%
|embench_minver.elf|918|0.00%
|embench_ud.elf|692|0.29%
|embench_st.elf|630|0.32%
|embench_nbody.elf|566|0.00%
|embench_matmult-int.elf|420|0.48%
|embench_crc32.elf|234|0.85%

|=======================

## C.SEXT.W and C.ZEXT.W  (No logic yet !!)


# Zces Subset: 

## C.PUSH
.. Traverse functions prologue 
.. Find negative stack adjustments
.. Find all stack relative store that has a negative offset and fits within the range 
_(abs(int(current_entry["Immediate"])+int(stack_adj_push[-1]["Adj"]["Immediate"])) < 60)_

.. Stop search at HOBs 
.. Check what is the maximum number of registers that we can fit in our replacement criteria
_rcount = { 0: ("ra",), 1: ("ra", "s0"),2: ("ra", "s0-s1"),3: ("ra", "s0-s2"),4:("ra", "s0-s3"),5: ("ra", "s0-s5"),6: ("ra", "s0-s8"),7: ("ra", "s0-s11")}_

.. Replace all instructions that fit the replacement criteria with the correct push instruction 

## C.POP and C.POPRET 
.. Traverse functions in reverse starting from epilogue
.. Find positive stack adjustments 
.. Find all stack relative  Load words that has positive offsets and fit within the range 
.. Stop search at HOBs 
.. Check what is the maximum number of registers that we can fit in our replacement criteria
.. Replace all instructions that fit the replacement criteria with the correct POP/POPRET instruction 

# Zced Subset: 

## C.DECBGEZ 
	. NO LOGIC YET

## C.SB 
	. Initial implementation and filtering to select best encoding, yet to adapt to replace entries.

## C.LBU 
	. Initial implementation and filtering to select best encoding, yet to adapt to replace entries.

## C.SH 
	. Initial implementation and filtering to select best encoding, yet to adapt to replace entries.

## C.LHU
	. Initial implementation and filtering to select best encoding, yet to adapt to replace entries.

